{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
    body {
        font-family: 'Poppins', sans-serif;
    }

    .table {
        border-radius: 15px;
        border: 3px solid #001489; 
    }

    .table thead th {
        background-color: #001489; 
        color: #ffffff; 
    }
</style>

<h2 style="font-family: 'Poppins', sans-serif; font-weight: 700;">Thrifty Owl Inventory</h2>
<div id="itemDetailsModal" class="modal">
    <div class="modal-content">
        <span class="close-container"><span class="close">&times;</span></span>
        <h2>Item Details</h2>
        <p id="itemName"></p>
        <p id="itemMaterial"></p>
        <p id="itemWeight"></p>
        <p id="itemStock"></p>
        <p id="itemValue"></p>
    </div>
</div>

<div class="inventory-window">
    <div>
        <input type="text" id="searchInput" placeholder="Search by 'Item Name' or 'Category'...">
        <input type="text" id="scannedBarcode" placeholder="Click here to scan barcode..." onfocus="this.placeholder = 'Scan desired barcode'" onblur="this.placeholder = 'Click here to scan barcode...'">
        
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-sm table-hover">
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Material</th>
                    <th>Weight (lb)</th>
                    <th>Category</th>
                    <th>Stock</th>
                    <th>Value Per Item</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="inventoryBody">
            </tbody>
            <tfoot>
                <tr id="totalRow">
                    <td colspan="3" style="text-align: right;"><strong>Total Weight:</strong></td>
                    <td id="totalWeight" colspan="4"></td>
                </tr>
                <tr id="totalValueRow" style="display: none;">
                    <td colspan="3" style="text-align: right;"><strong>Total Value:</strong></td>
                    <td id="totalValue" colspan="4"></td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3/dist/JsBarcode.all.min.js"></script>
<script>
//sweet alert updates changed the way the code is displayed?..(ask erik)
document.addEventListener('DOMContentLoaded', function() {
    fetchInventory();
    scanBarcode();
   
});

function showItemDetails(itemId) {
    fetch(`/get_item_details/${itemId}`)
        .then(response => response.json())
        .then(data => {
            // Prepare the HTML content for SweetAlert
            const itemDetailsHtml = `
                <p><strong>Item Name:</strong> ${data.item_name}</p>
                <p><strong>Material:</strong> ${data.material}</p>
                <p><strong>Weight:</strong> ${data.weight} lb</p>
                <p><strong>Stock:</strong> ${data.stock}</p>
                <p><strong>Value Per Item:</strong> $${data.value_per_item}</p>
            `;

            // Display the details using SweetAlert without a "Close" button
            Swal.fire({
                title: 'Item Details',
                html: itemDetailsHtml,
                showCloseButton: true, 
                focusConfirm: false,
                showConfirmButton: false,
                footer: '<button class="btn btn-primary" onclick="updateQuantity(' + itemId + ')" type="button" style="margin-right: 8px;">Add</button>' +
                        '<button class="btn btn-primary" onclick="releaseItem(' + itemId + ',\'' + data.item_name + '\')" type="button">Release</button>',
                showCancelButton: false,
                customClass: {
                    confirmButton: 'btn btn-success',
                },
                buttonsStyling: false,
                allowOutsideClick: true, 
                allowEscapeKey: true, 
            });
        });
}

function fetchInventory() {
    fetch(`/get_inventory`)
        .then(response => response.json())
        .then(data => {
            const inventoryBody = document.getElementById('inventoryBody');
            inventoryBody.innerHTML = '';
            let totalWeight = 0; 
            let totalValue = 0; 
            data.inventory.forEach(item => {
                const row = document.createElement('tr');
                row.id = `item_${item.id}`;  
                row.innerHTML = `
                    <td>${item.item_name}</td>
                    <td>${item.material}</td>
                    <td>${item.weight}</td>
                    <td>${item.type}</td>
                    <td><input type="number" id="quantity_${item.id}" value="${item.stock}" class="form-control"></td>
                    <td>${item.value_per_item}</td>
                    <td>
                        <button onclick="releaseItem(${item.id}, '${item.item_name}')" class="btn btn-primary"><i class="fas fa-minus"></i></button>
                        <button onclick="updateQuantity(${item.id})" class="btn btn-primary"><i class="fas fa-plus"></i></button>
                        <button onclick="printBarcode('${item.barcode}')" class="btn btn-success"><i class="fas fa-barcode"></i></button>
                        <button onclick="deleteItem(${item.id})" class="btn btn-danger"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                inventoryBody.appendChild(row);
                totalWeight += item.weight * item.stock; 
                totalValue += item.value_per_item * item.stock; 
            });

            
            const totalWeightCell = document.getElementById('totalWeight');
            totalWeightCell.textContent = `${totalWeight.toFixed(2)} lb`;

            
            const totalValueRow = document.getElementById('totalValueRow');
            const totalValueCell = document.getElementById('totalValue');
            totalValueCell.textContent = `$${totalValue.toFixed(2)}`;
            totalValueRow.style.display = ''; 
        })
        .catch(error => console.error('Error:', error));
}

document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.trim().toLowerCase();
    const tableRows = document.querySelectorAll('#inventoryBody tr');

    let totalWeight = 0; 
    let totalValue = 0; 

    tableRows.forEach(row => {
        const itemName = row.querySelector('td:first-child').textContent.trim().toLowerCase();
        const itemType = row.querySelector('td:nth-child(4)').textContent.trim().toLowerCase();
        if (itemName.includes(searchTerm) || itemType.includes(searchTerm)) {
            row.style.display = ''; 
            const itemStock = parseInt(row.querySelector('td:nth-child(5) input').value);
            const itemWeight = parseFloat(row.querySelector('td:nth-child(3)').textContent);
            const itemValue = parseFloat(row.querySelector('td:nth-child(6)').textContent);
            totalWeight += (itemWeight * itemStock); 
            totalValue += (itemValue * itemStock); 
        } else {
            row.style.display = 'none';
        }
    });

    
    const totalWeightCell = document.getElementById('totalWeight');
    totalWeightCell.textContent = `${totalWeight.toFixed(2)} lb`;

    const totalValueCell = document.getElementById('totalValue');
    totalValueCell.textContent = `$${totalValue.toFixed(2)}`;
});


function updateQuantity(itemId) {
    // Start with quantity input
    Swal.fire({
        title: 'Enter the quantity to add:',
        input: 'number',
        inputAttributes: {
            min: 1,
            step: 1,
            autocapitalize: 'off'
        },
        showCancelButton: true,
        confirmButtonText: 'Next',
        confirmButtonColor: '#001489',
        showLoaderOnConfirm: true,
    }).then((quantityResult) => {
        
        if (quantityResult.dismiss) {
            
            return;
        }
        
        if (quantityResult.isConfirmed && quantityResult.value) {
            
            Swal.fire({
                title: 'Enter donor information:',
                input: 'text',
                showCancelButton: true,
                confirmButtonText: 'Submit',
                confirmButtonColor: '#001489',
                showLoaderOnConfirm: true,
            }).then((donorResult) => {
                
                if (donorResult.dismiss) {
                    
                    return;
                }

                if (donorResult.isConfirmed && donorResult.value.trim() !== '') {
                    
                    const quantityToAdd = parseInt(quantityResult.value);
                    const newQuantity = parseInt(document.getElementById(`quantity_${itemId}`).value) + quantityToAdd;

                    fetch('/update_quantity', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ id: itemId, quantity_to_add: quantityToAdd, donor_info: donorResult.value }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById(`quantity_${itemId}`).value = newQuantity; // Update the input field
                            document.getElementById('itemStock').innerText = "Stock: " + newQuantity; // Update modal's stock display

                            Swal.fire({
                                icon: 'success',
                                title: 'Updated!',
                                text: data.message,
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: data.message,
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Something went wrong!',
                        });
                    });
                }
                else if (donorResult.isConfirmed) {
                    Swal.fire('Please enter donor information or select "Unknown".');
                }
            });
        }
        else if (quantityResult.isConfirmed) {
            Swal.fire('Please enter a valid quantity to add.');
        }
    });
}




function printBarcode(barcode) {
    if (barcode !== null) {
        const barcodeImage = new Image();

        JsBarcode(barcodeImage, barcode, {
            format: "CODE128",
            width: 2,
            height: 50
        });

        const printWindow = window.open('', '_blank');

        printWindow.document.body.appendChild(barcodeImage);

        printWindow.print();
    } else {
        alert("Barcode number is null.");
    }
}

function confirmDelete(itemId) {
    if (confirm("Are you sure you want to delete this item?")) {
        deleteItem(itemId);
    }
}

function deleteItem(itemId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Delete Item'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/delete_item', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: itemId }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted!',
                        text: data.message,
                    });
                    document.getElementById(`item_${itemId}`).remove(); 
                    fetchInventory(); 
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: data.message,
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Something went wrong!',
                });
            });
        }
    });
}


function releaseItem(itemId, itemName) {
    Swal.fire({
        title: 'Enter the quantity to release:',
        input: 'number',
        inputAttributes: {
            min: 1,
            step: 1,
            autocapitalize: 'off'
        },
        showCancelButton: true,
        confirmButtonText: 'Next',
        confirmButtonColor: '#001489',
        showLoaderOnConfirm: true,
    }).then((quantityResult) => {
        if (quantityResult.value) {
            Swal.fire({
                title: 'Enter recipient information:',
                input: 'text',
                showCancelButton: true,
                confirmButtonText: 'Release',
                showLoaderOnConfirm: true,
            }).then((donorResult) => {
                if (donorResult.value) {
                    const releaseData = {
                        item_name: itemName, 
                        item_id: itemId, 
                        quantity: parseInt(quantityResult.value), 
                        donor_info: donorResult.value
                    };
                    //endpoint match
                    fetch('/release_item', { 
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(releaseData),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            let quantityInput = document.getElementById(`quantity_${itemId}`);
                            let newQuantity = parseInt(quantityInput.value) - parseInt(quantityResult.value);
                            quantityInput.value = newQuantity; 
                            document.getElementById('itemStock').innerText = "Stock: " + newQuantity; 
                            Swal.fire('Released!', data.message, 'success');
                        } else {
                            Swal.fire('Oops...', data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Oops...', 'Something went wrong!', 'error');
                    });
                }
            });
        }
    });
}


function scanBarcode() {
    let scannedBarcode = '';
    let timer = null;
    const inputField = document.getElementById('scannedBarcode');

    inputField.addEventListener('input', function (event) {
        clearTimeout(timer);
        scannedBarcode = event.target.value;

        timer = setTimeout(function() {
            fetch('/scan_barcode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ barcode: scannedBarcode }),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data); 
                if (data.success) {
                    
                    showItemDetails(data.itemId);
                } else {
                    alert(`Item not found: ${scannedBarcode}. ${data.message}`);
                }
            })
            .catch(error => console.error('Error:', error));

            
            scannedBarcode = '';
            inputField.value = '';
        }, 500); 
    });
}

document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.trim().toLowerCase();
    const tableRows = document.querySelectorAll('#inventoryBody tr');

    tableRows.forEach(row => {
        const itemName = row.querySelector('td:first-child').textContent.trim().toLowerCase();
        const itemType = row.querySelector('td:nth-child(4)').textContent.trim().toLowerCase();
        if (itemName.includes(searchTerm) || itemType.includes(searchTerm)) {
            row.style.display = ''; 
        } else {
            row.style.display = 'none'; 
        }
    });
});
</script>
{% endblock %}