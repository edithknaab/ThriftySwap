{% extends "ssbase.html" %}
{% block content %}
<h1>Swap Shop Inventory</h1>
<div id="itemDetailsModal" class="modal">
    <div class="modal-content">
      <span class="close-container"><span class="close">&times;</span></span>
      <h2>Item Details</h2>
      <p id="itemName"></p>
      <p id="itemMaterial"></p>
      <p id="itemWeight"></p>
      <p id="itemStock"></p>
      <p id="itemValue"></p>
    </div>
</div>
<div class="inventory-window">
    <input type="text" id="scannedBarcode" placeholder="Scan Barcode..." onfocus="this.placeholder = ''" onblur="this.placeholder = 'Scan Barcode...'">
<div>
    <input type="text" id="searchInput" placeholder="Search by Item Name">
</div>
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Material</th>
                    <th>Weight (kg)</th>
                    <th>Stock</th>
                    <th>Value Per Item</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="inventoryBody">
                {% for item in items %}
                <tr>
                    <td>{{ item.item_name }}</td>
                    <td>{{ item.material }}</td>
                    <td>{{ item.weight }}</td>
                    <td><input type="number" id="quantity_{{ item.id }}" value="{{ item.stock }}" class="form-control" readonly></td>
                    <td>{{ item.value_per_item }}</td>
                    <td>
                        <button onclick="releaseItem('{{ item.id }}', '{{ item.item_name }}')" class="btn btn-primary"><i class="bi bi-box-arrow-up"></i> Release</button>
                        <button onclick="updateQuantity('{{ item.id }}')" class="btn btn-primary"><i class="bi bi-pencil-square"></i> Update </button>
                        <button onclick="printBarcode('{{ item.barcode }}')" class="btn btn-success"><i class="bi bi-printer"></i> Print Barcode</button>
                        <button onclick="deleteItem('{{ item.id }}')" class="btn btn-danger"><i class="bi bi-trash"></i> Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3/dist/JsBarcode.all.min.js"></script>
<script>

document.addEventListener('DOMContentLoaded', function() {
    fetchInventory();
    scanBarcode();
    // Create a new div for the buttons
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'button-container';

    // Create the Update button
    const updateButton = document.createElement('button');
    updateButton.onclick = function() { updateQuantity(itemId); };
    updateButton.className = 'btn btn-primary modal-button';
    updateButton.textContent = 'Update';

    // Create the Release button
    const releaseButton = document.createElement('button');
    releaseButton.onclick = function() { releaseItem(itemId, data.item_name); };
    releaseButton.className = 'btn btn-primary modal-button';
    releaseButton.textContent = 'Release';

    // Add the buttons to the buttonContainer
    buttonContainer.appendChild(updateButton);
    buttonContainer.appendChild(releaseButton);

    // Add the buttonContainer to the modalContent
    modalContent.appendChild(buttonContainer);

    // Set focus on the barcode input field
    document.getElementById('scannedBarcode').focus();

    // Get the modal and the close button
    var modal = document.getElementById('itemDetailsModal');
    var closeButton = document.querySelector('.close');

    // When the user clicks on the close button, close the modal
    closeButton.onclick = function() {
      modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }
});

function showItemDetails(itemId) {
    fetch(`/get_ssitem_details/${itemId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('itemName').innerText = "Item Name: " + data.item_name;
            document.getElementById('itemMaterial').innerText = "Material: " + data.material;
            document.getElementById('itemWeight').innerText = "Weight: " + data.weight;
            document.getElementById('itemStock').innerText = "Stock: " + data.stock;
            document.getElementById('itemValue').innerText = "Value Per Item: " + data.value_per_item;

            
            const modalContent = document.querySelector('.modal-content');
            
            
            const oldButtons = modalContent.querySelectorAll('button');
            oldButtons.forEach(button => button.remove());

            modalContent.innerHTML += `
            <div class="button-container">
                <button onclick="updateQuantity(${itemId})" class="btn btn-primary modal-button">Update</button>
                <button onclick="releaseItem(${itemId}, '${data.item_name}')" class="btn btn-primary modal-button">Release</button>
            </div>
            `;

            
            document.getElementById('itemDetailsModal').style.display = "block";

            
            var modal = document.getElementById('itemDetailsModal');
            var closeButton = document.querySelector('.close');

            
            closeButton.onclick = function() {
              modal.style.display = "none";
            }

            
            window.onclick = function(event) {
              if (event.target == modal) {
                modal.style.display = "none";
              }
            }
        });
}

function fetchInventory() {
    fetch(`/get_swap_shop_inventory`)
        .then(response => response.json())
        .then(data => {
            const inventoryBody = document.getElementById('inventoryBody');
            inventoryBody.innerHTML = '';
            data.inventory.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.item_name}</td>
                    <td>${item.material}</td>
                    <td>${item.weight}</td>
                    <td>${item.type ? item.type : 'N/A'}</td>
                    <td><input type="number" id="quantity_${item.id}" value="${item.stock}" class="form-control"></td>
                    <td>${item.value_per_item}</td>
                    <td>
                        <button onclick="releaseItem(${item.id}, '${item.item_name}')" class="btn btn-primary"><i class="bi bi-box-arrow-up"></i> Release</button>
                        <button onclick="updateQuantity(${item.id})" class="btn btn-primary"><i class="bi bi-pencil-square"></i> Update </button>
                        <button onclick="printBarcode('${item.barcode}')" class="btn btn-success"><i class="bi bi-printer"></i> Print Barcode</button>
                        <button onclick="deleteItem(${item.id})" class="btn btn-danger"><i class="bi bi-trash"></i> Delete</button>
                    </td>
                `;

                inventoryBody.appendChild(row);
            });
        })
        .catch(error => console.error('Error:', error));
}
function printBarcode(barcode) {
    if (barcode !== null) {
        const barcodeImage = new Image();

        JsBarcode(barcodeImage, barcode, {
            format: "CODE128",
            width: 2,
            height: 50
        });

        const printWindow = window.open('', '_blank');

        printWindow.document.body.appendChild(barcodeImage);

        printWindow.print();
    } else {
        alert("Barcode number is null.");
    }
}
function releaseItem(itemId, itemName) {
    var quantity = prompt("Enter the quantity to release:");
    var donorInfo = prompt("Enter donor information:");
    if (quantity !== null && !isNaN(quantity) && quantity.trim() !== '' && donorInfo !== null && donorInfo.trim() !== '') {
        fetch('/release_item_ss', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ item_id: itemId, quantity: parseInt(quantity), donor_info: donorInfo }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                
                var quantityInput = document.getElementById(`quantity_${itemId}`);
                var currentQuantity = parseInt(quantityInput.value);
                var releasedQuantity = parseInt(quantity);
                quantityInput.value = currentQuantity - releasedQuantity; // Decrease the quantity
                
                var modalStock = document.getElementById('itemStock');
                var currentStock = parseInt(modalStock.innerText.split(' ')[1]);
                modalStock.innerText = "Stock: " + (currentStock - releasedQuantity);
                
                alert(data.message);
            } else {
                alert(data.message);
            }
        })
        .catch(error => console.error('Error:', error));
    } else {
        alert("Please enter a valid quantity and donor information.");
    }
}

function updateQuantity(itemId) {
    const quantityInput = document.getElementById(`quantity_${itemId}`);
    const quantityToAdd = parseInt(prompt("Enter the quantity to add:"));

    if (!isNaN(quantityToAdd) && quantityToAdd > 0) {
        const donorInfo = prompt("Enter donor information:");
        if (donorInfo !== null && donorInfo.trim() !== '') {
            fetch('/update_quantity_ss', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ item_id: itemId, quantity_to_add: quantityToAdd, donor_info: donorInfo }), 
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    
                    const currentQuantity = parseInt(quantityInput.value);
                    quantityInput.value = currentQuantity + quantityToAdd; 

                    
                    const modalStock = document.getElementById('itemStock');
                    const currentStock = parseInt(modalStock.innerText.split(' ')[1]);
                    modalStock.innerText = "Stock: " + (currentStock + quantityToAdd);

                    alert(data.message);

                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        } else {
            alert("Please enter donor information.");
        }
    } else {
        alert("Please enter a valid quantity to add.");
    }
}

function scanBarcode() {
    let scannedBarcode = '';
    let timer = null;
    const inputField = document.getElementById('scannedBarcode');

    inputField.addEventListener('input', function (event) {
        clearTimeout(timer);
        scannedBarcode = event.target.value;

        timer = setTimeout(function() {
            const payload = JSON.stringify({ barcode: scannedBarcode });
            console.log('Sending barcode:', scannedBarcode); 

            fetch('/scan_barcode_swap_shop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: payload,
            })
            .then(response => response.json())
            .then(data => {
                console.log('Received:', data); 
                if (data.success) {
                    
                    showItemDetails(data.itemId);
                } else {
                    alert(`Item not found: ${scannedBarcode}. ${data.message}`);
                }
            })
            .catch(error => console.error('Error:', error));

            
            scannedBarcode = '';
            inputField.value = '';
        }, 500); 
    });
}
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.trim().toLowerCase();
    const tableRows = document.querySelectorAll('#inventoryBody tr');

    tableRows.forEach(row => {
        const itemName = row.querySelector('td:first-child').textContent.trim().toLowerCase();
        if (itemName.includes(searchTerm)) {
            row.style.display = ''; 
        } else {
            row.style.display = 'none'; 
        }
    });
});
</script>
{% endblock %}
